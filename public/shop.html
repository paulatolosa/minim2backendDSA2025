<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Botiga - DriveN'Dodge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <style>
        body {
            background-color: #1a1a1a; /* Fons fosc */
            color: #f0f0f0;
        }
        .navbar-custom {
            background-color: #000000;
            border-bottom: 2px solid #ffc107;
        }
        .card {
            background-color: #2c2c2c;
            border: 1px solid #444;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
        }
        .text-gold {
            color: #ffc107;
        }
        .btn-buy {
            background-color: #ffc107;
            color: #000;
            font-weight: bold;
            border: none;
        }
        .btn-buy:hover {
            background-color: #e0a800;
            color: #fff;
        }
        .nav-link:hover {
            color: #ffc107 !important;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark navbar-custom sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold text-gold" href="index.html">üèéÔ∏è DriveN'Dodge</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active text-gold" href="shop.html">üõí Botiga</a>
                </li>
                <li class="nav-item">
                        <a class="nav-link" href="inventario.html">üéí Inventari</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="ranking.html">üèÜ Ranking</a>
                </li>
            </ul>

            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item me-3">
                    <div class="d-flex align-items-center bg-dark border border-warning rounded px-3 py-1">
                        <span class="me-2">üí∞</span>
                        <span id="coins-display" class="fw-bold text-white">---</span>
                    </div>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                        üë§ <span id="username-display">Usuari</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end bg-dark border-secondary">
                        <li><a class="dropdown-item text-light" href="profile.html">Mi Perfil</a></li>
                        <li><hr class="dropdown-divider bg-secondary"></li>
                        <li><a class="dropdown-item text-danger" href="#" id="btn-logout">Cerrar Sesi√≥n</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h2 class="text-center mb-5 text-uppercase fw-bold"><span class="text-gold">Botiga</span> d'Objectes</h2>

    <div id="shop-items-container" class="row">
        <div class="text-center py-5">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Carregant...</span>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function() {
        // 1. Verificar Sessi√≥
        let username = localStorage.getItem("username");
        if (!username) {
            window.location.href = "index.html"; // Redirigir si no hi ha login
            return;
        }

        // Actualitzar nom al men√∫
        $('#username-display').text(username);

        // 2. Carregar Dades Inicials
        loadUserCoins();
        loadShopItems();

        // --- FUNCI√ì 1: TANCAR SESSI√ì ---
        $('#btn-logout').click(function(e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = "index.html"; // O login.html
        });

        // --- FUNCI√ì 2: CARREGAR MONEDES ---
        function loadUserCoins() {
            $.ajax({
                type: 'GET',
                url: '/v1/shop/monedas/' + username,
                dataType: 'json',
                success: function(response) {
                    $('#coins-display').text(response.coins);
                },
                error: function() {
                    console.log("Error carregant monedes");
                }
            });
        }

        // --- FUNCI√ì 3: CARREGAR ITEMS (Amb el Fix de les Imatges) ---
        function loadShopItems() {
            $.ajax({
                type: 'GET',
                url: '/v1/shop/items',
                dataType: 'json',
                success: function(items) {
                    console.log("ITEMS REBUTS JSON:", items);
                    let container = $('#shop-items-container');
                    container.empty();

                    if (!items || items.length === 0) {
                        container.html('<h3 class="text-center text-muted">No hi ha items disponibles actualment.</h3>');
                        return;
                    }

                    items.forEach(function(item) {
                        // CORRECCI√ì DE RUTA D'IMATGE (Fix definitiu)
                        let ruta = item.imagen;
                        // Si no es URL absoluta (http) i no comen√ßa per /, li posem la barra
                        if (!ruta.startsWith("http") && !ruta.startsWith("/")) {
                            ruta = "/" + ruta;
                        }
                        let idReal = item.id || item.ID;
                        if (!idReal) console.error("ALERTA: Aquest item no t√© ID!", item);
                        let html = `
                                <div class="col-md-4 mb-4">
                                    <div class="card h-100">
                                        <div class="p-3 text-center" style="background-color: #222; border-bottom: 1px solid #444;">
                                            <img src="${ruta}" class="img-fluid" alt="${item.nombre}"
                                                 style="height: 180px; object-fit: contain;"
                                                 onerror="this.src='https://placehold.co/200x200?text=No+Image';">
                                        </div>
                                        <div class="card-body d-flex flex-column text-center">
                                            <h5 class="card-title text-gold fw-bold">${item.nombre}</h5>
                                            <p class="card-text small text-secondary">${item.descripcion}</p>

                                            <div class="mt-auto pt-3">
                                                <h4 class="fw-bold mb-3">${item.precio} üí∞</h4>
                                                <button class="btn btn-buy w-100 py-2 rounded-pill shadow-sm btn-buy"
                                                        data-item-id="${idReal}"
                                                        data-item-price="${item.precio}"
                                                        data-item-name="${item.nombre}">
                                                    COMPRAR ARA
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        container.append(html);
                    });
                },
                error: function(xhr) {
                    console.error("Error carregant items:", xhr);
                    $('#shop-items-container').html('<p class="text-danger text-center">Error connectant amb el servidor.</p>');
                }
            });
        }

        // --- FUNCI√ì 4: COMPRAR ITEM ---
        $(document).on('click', '.btn-buy', function() {
            const itemId = $(this).data('item-id');
            const itemName = $(this).data('item-name');
            const itemPrice = parseInt($(this).data('item-price'));
            let currentCoins = parseInt($('#coins-display').text());

            if (currentCoins < itemPrice) {
                alert("‚ö†Ô∏è No tens suficients monedes per comprar " + itemName);
                return;
            }

            // Confirmaci√≥ simple
            if(!confirm("Vols comprar " + itemName + " per " + itemPrice + " monedes?")) return;

            $.ajax({
                type: 'POST',
                url: '/v1/shop/buy/' + itemId,
                contentType: 'application/json',
                data: JSON.stringify(username),
                success: function(response) {
                    alert("‚úÖ Compra realitzada: " + itemName);
                    loadUserCoins(); // Actualitzem saldo
                },
                error: function(xhr) {
                    let errorMsg = "Error desconegut";
                    if(xhr.responseJSON && xhr.responseJSON.message) errorMsg = xhr.responseJSON.message;
                    alert("‚ùå Error en la compra: " + errorMsg);
                }
            });
        });
    });
</script>
</body>
</html>